<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preload" href="./font/bfont.woff2" as="font" type="font/woff2" crossorigin />
  <title>Analog pacing‑klokke</title>
  <style>
    @font-face {
      font-family: 'BFont';
      src: url('./font/bfont.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: block;
    }
    body {
      margin:0;
      background:black;
      display:flex;
      justify-content:flex-start;
      align-items:stretch;
      height:100vh;
      color:white;
      font-family: 'BFont', Arial, sans-serif;
      gap:24px;
    }
    #leftPanel {
      display:none; /* hidden by default; can be enabled via URL flag */
      flex-direction:column;
      gap:16px;
      padding:16px;
      box-sizing:border-box;
      width:260px;
      max-width:40vw;
      max-height:100vh;
      overflow-y:auto;
    }
    #rightPanel {
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      box-sizing:border-box;
    }
    #clock {
      background:black;
      display:block;
    }
    .groupTitle {
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.8;
      margin-bottom:4px;
    }
    .controls {
      font-size:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .controls label {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .controls input[type="range"] {
      width:100%;
    }
    .controls select {
      width:100%;
      padding:4px;
      background:black;
      color:white;
      border:1px solid #666;
    }
    .controls span.value {
      font-size:11px;
      opacity:0.8;
    }
  </style>
</head>
<body>
  <div id="leftPanel">
  <details>
      <summary class="groupTitle">Clock geometry</summary>
      <div class="controls" id="clockControls">
        <label>
          Outer size (vs screen height)
          <input id="outerRelSlider" type="range" min="0.2" max="1" step="0.001" />
          <span class="value" id="outerRelValue"></span>
        </label>
        <label>
          Major tick inner radius
          <input id="majorInnerSlider" type="range" min="0.5" max="1" step="0.001" />
          <span class="value" id="majorInnerValue"></span>
        </label>       
        <label>
          Minor tick outer radius
          <input id="minorOuterRelSlider" type="range" min="0.5" max="1" step="0.001" />
          <span class="value" id="minorOuterRelValue"></span>
        </label>
          Minor tick inner radius
          <input id="minorInnerSlider" type="range" min="0.5" max="1" step="0.001" />
          <span class="value" id="minorInnerValue"></span>
        </label>
        <label>
          Major tick width (vs radius)
          <input id="majorWidthRelSlider" type="range" min="0" max="0.1" step="0.001" />
          <span class="value" id="majorWidthRelValue"></span>
        </label>
          Minor tick width (vs radius)
          <input id="minorWidthRelSlider" type="range" min="0" max="0.1" step="0.001" />
          <span class="value" id="minorWidthRelValue"></span>
        </label>
      </div>
    </details>

  <details>
      <summary class="groupTitle">Hands & diamond (relative to clock radius)</summary>
      <div class="controls" id="handControls">
        <label>
          Tip radius (0–1)
          <input id="tipRelSlider" type="range" min="0.7" max="1" step="0.001" />
          <span class="value" id="tipRelValue"></span>
        </label>
        <label>
          Shaft width (vs radius)
          <input id="shaftWidthRelSlider" type="range" min="0" max="0.08" step="0.001" />
          <span class="value" id="shaftWidthRelValue"></span>
        </label>
        <label>
          Diamond base inset (vs radius)
          <input id="diamondBaseInsetRelSlider" type="range" min="0" max="0.4" step="0.001" />
          <span class="value" id="diamondBaseInsetRelValue"></span>
        </label>
        <label>
          Diamond back (vs radius)
          <input id="diamondBackRelSlider" type="range" min="0" max="0.2" step="0.005" />
          <span class="value" id="diamondBackRelValue"></span>
        </label>
        <label>
          Diamond width (vs radius)
          <input id="diamondWidthRelSlider" type="range" min="0" max="0.2" step="0.001" />
          <span class="value" id="diamondWidthRelValue"></span>
        </label>
        <label>
          Center circle radius (vs radius)
          <input id="centerCircleRelSlider" type="range" min="0" max="0.2" step="0.001" />
          <span class="value" id="centerCircleRelValue"></span>
        </label>
      </div>
    </details>

  <details>
      <summary class="groupTitle">Numbers (relative)</summary>
      <div class="controls" id="numberControls">
        <label>
          Number radius (0–1)
          <input id="numberRadiusRelSlider" type="range" min="0" max="1" step="0.01" />
          <span class="value" id="numberRadiusRelValue"></span>
        </label>
        <label>
          Number font size (vs radius)
          <input id="numberFontRelSlider" type="range" min="0.02" max="0.3" step="0.001" />
          <span class="value" id="numberFontRelValue"></span>
        </label>
        <div style="margin-top:12px;font-size:13px;opacity:0.8;">Fine tune number positions</div>
        <div id="numberOffsetSliders" style="display:flex;flex-direction:column;gap:8px;">
          <label>5: X <input id="num5x" type="range" min="-0.2" max="0.2" step="0.001" value="0.034" /> <span class="value" id="num5xVal">0</span> Y <input id="num5y" type="range" min="-0.2" max="0.2" step="0.001" value="-0.007" /> <span class="value" id="num5yVal">0</span></label>
          <label>10: X <input id="num10x" type="range" min="-0.2" max="0.2" step="0.001" value="0.004" /> <span class="value" id="num10xVal">0</span> Y <input id="num10y" type="range" min="-0.2" max="0.2" step="0.001" value="0.000" /> <span class="value" id="num10yVal">0</span></label>
          <label>15: X <input id="num15x" type="range" min="-0.2" max="0.2" step="0.001" value="0.022" /> <span class="value" id="num15xVal">0</span> Y <input id="num15y" type="range" min="-0.2" max="0.2" step="0.001" value="0.010" /> <span class="value" id="num15yVal">0</span></label>
          <label>20: X <input id="num20x" type="range" min="-0.2" max="0.2" step="0.001" value="0.004" /> <span class="value" id="num20xVal">0</span> Y <input id="num20y" type="range" min="-0.2" max="0.2" step="0.001" value="0.010" /> <span class="value" id="num20yVal">0</span></label>
          <label>25: X <input id="num25x" type="range" min="-0.2" max="0.2" step="0.001" value="0.019" /> <span class="value" id="num25xVal">0</span> Y <input id="num25y" type="range" min="-0.2" max="0.2" step="0.001" value="0.016" /> <span class="value" id="num25yVal">0</span></label>
          <label>30: X <input id="num30x" type="range" min="-0.2" max="0.2" step="0.001" value="0.001" /> <span class="value" id="num30xVal">0</span> Y <input id="num30y" type="range" min="-0.2" max="0.2" step="0.001" value="0.049" /> <span class="value" id="num30yVal">0</span></label>
          <label>35: X <input id="num35x" type="range" min="-0.2" max="0.2" step="0.001" value="-0.007" /> <span class="value" id="num35xVal">0</span> Y <input id="num35y" type="range" min="-0.2" max="0.2" step="0.001" value="0.016" /> <span class="value" id="num35yVal">0</span></label>
          <label>40: X <input id="num40x" type="range" min="-0.2" max="0.2" step="0.001" value="0.004" /> <span class="value" id="num40xVal">0</span> Y <input id="num40y" type="range" min="-0.2" max="0.2" step="0.001" value="0.007" /> <span class="value" id="num40yVal">0</span></label>
          <label>45: X <input id="num45x" type="range" min="-0.2" max="0.2" step="0.001" value="-0.013" /> <span class="value" id="num45xVal">0</span> Y <input id="num45y" type="range" min="-0.2" max="0.2" step="0.001" value="0.013" /> <span class="value" id="num45yVal">0</span></label>
          <label>50: X <input id="num50x" type="range" min="-0.2" max="0.2" step="0.001" value="0.004" /> <span class="value" id="num50xVal">0</span> Y <input id="num50y" type="range" min="-0.2" max="0.2" step="0.001" value="-0.001" /> <span class="value" id="num50yVal">0</span></label>
          <label>55: X <input id="num55x" type="range" min="-0.2" max="0.2" step="0.001" value="0.007" /> <span class="value" id="num55xVal">0</span> Y <input id="num55y" type="range" min="-0.2" max="0.2" step="0.001" value="-0.007" /> <span class="value" id="num55yVal">0</span></label>
          <label>60: X <input id="num60x" type="range" min="-0.2" max="0.2" step="0.001" value="0.000" /> <span class="value" id="num60xVal">0</span> Y <input id="num60y" type="range" min="-0.2" max="0.2" step="0.001" value="-0.034" /> <span class="value" id="num60yVal">0</span></label>
        </div>
      </div>
    </details>

    <details>
      <summary class="groupTitle">Digital display</summary>
      <div class="controls" id="vfdControls">
        <label style="flex-direction:row;align-items:center;gap:8px;">
          <input id="showVFDCheckbox" type="checkbox" checked /> Show digital display
        </label>
        <label>
          Color
          <input id="vfdColorInput" type="color" value="#00b7ff" />
          <span class="value" id="vfdColorVal"></span>
        </label>
        <label>
          Test pattern
          <select id="vfdTestModeSelect">
            <option value="normal">Normal (HH:MM)</option>
            <option value="all">All dots on</option>
            <option value="88">88:88</option>
          </select>
          <span class="value" id="vfdTestModeVal"></span>
        </label>
        <label>
          Scale (relative)
          <input id="vfdSizeRelSlider" type="range" min="0.2" max="1.2" step="0.001" />
          <span class="value" id="vfdSizeRelVal"></span>
        </label>
        <label>
          Vertical offset (rel radius)
          <input id="vfdYOffsetSlider" type="range" min="-0.5" max="0.5" step="0.01" />
          <span class="value" id="vfdYOffsetVal"></span>
        </label>
        <label>
          Colon padding (dots)
          <input id="vfdColonPaddingSlider" type="range" min="0" max="3" step="0.1" />
          <span class="value" id="vfdColonPaddingVal"></span>
        </label>
        <label>
          Digit spacing (extra)
          <input id="vfdDigitGapRelSlider" type="range" min="-0.5" max="2" step="0.01" />
          <span class="value" id="vfdDigitGapRelVal"></span>
        </label>
        <label>
          Corner radius (rel)
          <input id="vfdCornerRelSlider" type="range" min="0" max="1" step="0.05" />
          <span class="value" id="vfdCornerRelVal"></span>
        </label>
        <label>
          Glow intensity
          <input id="vfdGlowRelSlider" type="range" min="0" max="8" step="0.1" />
          <span class="value" id="vfdGlowRelVal"></span>
        </label>
      </div>
    </details>

    <details>
      <summary class="groupTitle">Minute hand</summary>
      <div class="controls" id="minuteControls">
        <label style="flex-direction:row;align-items:center;gap:8px;">
          <input id="showMinuteCheckbox" type="checkbox" checked /> Enable minute hand
        </label>
        <label>
          Shaft width (vs radius)
          <input id="minuteShaftWidthRelSlider" type="range" min="0" max="0.08" step="0.001" />
          <span class="value" id="minuteShaftWidthRelValue"></span>
        </label>
        <label>
          Tip radius (0–1)
          <input id="minuteTipRelSlider" type="range" min="0.7" max="1" step="0.001" />
          <span class="value" id="minuteTipRelValue"></span>
        </label>
        <label>
          Diamond base inset (vs radius)
          <input id="minuteDiamondBaseInsetRelSlider" type="range" min="0" max="0.4" step="0.001" />
          <span class="value" id="minuteDiamondBaseInsetRelValue"></span>
        </label>
        <label>
          Diamond back (vs radius)
          <input id="minuteDiamondBackRelSlider" type="range" min="0" max="0.2" step="0.005" />
          <span class="value" id="minuteDiamondBackRelValue"></span>
        </label>
        <label>
          Diamond width (vs radius)
          <input id="minuteDiamondWidthRelSlider" type="range" min="0" max="0.2" step="0.001" />
          <span class="value" id="minuteDiamondWidthRelValue"></span>
        </label>
        <label>
          Hand color
          <input id="minuteColorInput" type="color" value="#888888" />
          <span class="value" id="minuteColorValue"></span>
        </label>
      </div>
    </details>

  <details>
      <summary class="groupTitle">Reference image</summary>
      <div class="controls" id="bgControls">
        <label style="flex-direction:row;align-items:center;gap:8px;">
          <input id="showBgCheckbox" type="checkbox" /> Show reference image
        </label>
        <label>
          Background scale
          <input id="bgScaleRelSlider" type="range" min="0.9" max="1.1" step="0.001" />
          <span class="value" id="bgScaleRelValue"></span>
        </label>
      </div>
    </details>

  <details>
      <summary class="groupTitle">Animation control</summary>
      <div class="controls" id="animControls">
        <label style="flex-direction:row;align-items:center;gap:8px;">
          <input id="runClockCheckbox" type="checkbox" checked /> Run clock
        </label>
        <label>
          Manual dial angle (0–1 turns)
          <input id="manualAngleSlider" type="range" min="0" max="1" step="0.001" />
          <span class="value" id="manualAngleValue"></span>
        </label>
        <label style="flex-direction:row;align-items:center;gap:8px;">
          <input id="showLogoCheckbox" type="checkbox" checked /> Show rotating logo
        </label>
        <label>
          Logo size (relative)
          <input id="logoSizeRelSlider" type="range" min="0" max="0.2" step="0.001" />
          <span class="value" id="logoSizeRelValue"></span>
        </label>
      </div>
    </details>

  <details>
      <summary class="groupTitle">Share / link</summary>
      <div class="controls">
        <button id="copyUrlButton" type="button">Copy URL for this setup</button>
        <span class="value" id="copyUrlStatus"></span>
      </div>
    </details>
  </div>

  <div id="rightPanel">
    <canvas id="clock"></canvas>
  </div>

<script>
// Number offset state: { [number]: {x, y} }
const numberOffsets = {
  5:  {x:0, y:0}, 10: {x:0, y:0}, 15: {x:0, y:0}, 20: {x:0, y:0},
  25: {x:0, y:0}, 30: {x:0, y:0}, 35: {x:0, y:0}, 40: {x:0, y:0},
  45: {x:0, y:0}, 50: {x:0, y:0}, 55: {x:0, y:0}, 60: {x:0, y:0}
};

// Wire up slider event handlers for each number
for (const n of [5,10,15,20,25,30,35,40,45,50,55,60]) {
  const xSlider = document.getElementById(`num${n}x`);
  const ySlider = document.getElementById(`num${n}y`);
  const xVal = document.getElementById(`num${n}xVal`);
  const yVal = document.getElementById(`num${n}yVal`);
  xSlider.addEventListener('input', () => {
    numberOffsets[n].x = parseFloat(xSlider.value);
    xVal.textContent = xSlider.value;
  });
  ySlider.addEventListener('input', () => {
    numberOffsets[n].y = parseFloat(ySlider.value);
    yVal.textContent = ySlider.value;
  });
}
// Initialize offsets from slider default values (so HTML value attributes are respected)
for (const n of [5,10,15,20,25,30,35,40,45,50,55,60]) {
  const xSlider = document.getElementById(`num${n}x`);
  const ySlider = document.getElementById(`num${n}y`);
  const xVal = document.getElementById(`num${n}xVal`);
  const yVal = document.getElementById(`num${n}yVal`);
  if (xSlider && ySlider && xVal && yVal) {
    const xv = parseFloat(xSlider.value);
    const yv = parseFloat(ySlider.value);
    numberOffsets[n].x = Number.isFinite(xv) ? xv : 0;
    numberOffsets[n].y = Number.isFinite(yv) ? yv : 0;
    xVal.textContent = xSlider.value;
    yVal.textContent = ySlider.value;
  }
}
const canvas = document.getElementById('clock');
const ctx = canvas.getContext('2d');
const leftPanel = document.getElementById('leftPanel');

// Show setup sliders only when URL contains the token "setupmode"
const url = window.location.href;
const showSetupPanel = url.includes('setupmode');
leftPanel.style.display = showSetupPanel ? 'flex' : 'none';

// Helper: read URL parameters (e.g. ?outerRel=0.9&logoSizeRel=0.05)
const params = new URLSearchParams(window.location.search);

function paramFloat(name, current) {
  const v = params.get(name);
  if (v === null) return current;
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : current;
}

function paramBool(name, current) {
  const v = params.get(name);
  if (v === null) return current;
  const low = v.toLowerCase();
  if (low === '1' || low === 'true') return true;
  if (low === '0' || low === 'false') return false;
  return current;
}

// ===== Relative configuration (all 0–1 where noted) =====
// Defaults
const DEFAULT_outerRel            = 0.95;
const DEFAULT_minorInnerRel       = 0.816;
const DEFAULT_majorInnerRel       = 0.774;
const DEFAULT_minorOuterRel       = 0.955;
const DEFAULT_minorWidthRel       = 0.009;
const DEFAULT_majorWidthRel       = 0.026;
const DEFAULT_numberRadiusRel     = 0.63;
const DEFAULT_numberFontRel       = 0.229;
const DEFAULT_centerCircleRel     = 0.038;
const DEFAULT_shaftWidthRel       = 0.04;
const DEFAULT_tipRel              = 0.986;
const DEFAULT_diamondBaseInsetRel = 0.247;
const DEFAULT_diamondBackRel      = 0.025;
const DEFAULT_diamondWidthRel     = 0.098;
// Distinct defaults for the minute hand to make it visually different
const DEFAULT_minuteShaftWidthRel  = 0.015;   // slightly thinner than the main shaft (default 0.04)
const DEFAULT_minuteTipRel         = 1.000;  // reach a bit closer to the tick marks
const DEFAULT_minuteDiamondBaseInsetRel = 0.058; // move diamond centre slightly outwards
const DEFAULT_minuteDiamondBackRel = 0.135;  // smaller inner inset
const DEFAULT_minuteDiamondWidthRel = 0.112;  // narrower diamond head
const DEFAULT_minuteColor          = '#444444'; // lighter grey for contrast
const DEFAULT_showMinute           = true;  // remain enabled by default
const DEFAULT_bgScaleRel          = 1.073;
const DEFAULT_logoSizeRel         = 0.120;
const DEFAULT_showLogo            = false;
const DEFAULT_runClock            = true;
const DEFAULT_manualAngle         = 0.00;
const DEFAULT_showBg              = false;

// Digital VFD defaults
const DEFAULT_vfdEnabled         = true;
const DEFAULT_vfdColor           = '#00b7ff';
const DEFAULT_vfdScaleRel        = 0.346;   // 50% of base dot size
const DEFAULT_vfdYOffsetRel      = 0.300;  // vertical placement multiplier used earlier
const DEFAULT_vfdColonPadding    = 0.400;   // in dot spacings
const DEFAULT_vfdCornerRel       = 0.25;  // corner radius relative to dotRadius
const DEFAULT_vfdGlowRel         = 0.000;   // shadow blur multiplier
const DEFAULT_vfdDigitGapRel     = 0.380;   // extra digit spacing multiplier (adds to base gap factor)

// Live values (start at defaults)
let outerRel            = DEFAULT_outerRel;
let minorInnerRel       = DEFAULT_minorInnerRel;
let majorInnerRel       = DEFAULT_majorInnerRel;
let minorOuterRel       = DEFAULT_minorOuterRel;
let minorWidthRel       = DEFAULT_minorWidthRel;
let majorWidthRel       = DEFAULT_majorWidthRel;
let numberRadiusRel     = DEFAULT_numberRadiusRel;
let numberFontRel       = DEFAULT_numberFontRel;
let centerCircleRel     = DEFAULT_centerCircleRel;
let shaftWidthRel       = DEFAULT_shaftWidthRel;
let tipRel              = DEFAULT_tipRel;
let diamondBaseInsetRel = DEFAULT_diamondBaseInsetRel;
let diamondBackRel      = DEFAULT_diamondBackRel;
let diamondWidthRel     = DEFAULT_diamondWidthRel;
let bgScaleRel          = DEFAULT_bgScaleRel;
let logoSizeRel         = DEFAULT_logoSizeRel;
let showLogo            = DEFAULT_showLogo;
let runClock            = DEFAULT_runClock;
let manualAngle         = DEFAULT_manualAngle;
let showBg              = DEFAULT_showBg;
let minuteShaftWidthRel = DEFAULT_minuteShaftWidthRel;
let minuteTipRel        = DEFAULT_minuteTipRel;
let minuteDiamondBaseInsetRel = DEFAULT_minuteDiamondBaseInsetRel;
let minuteDiamondBackRel = DEFAULT_minuteDiamondBackRel;
let minuteDiamondWidthRel = DEFAULT_minuteDiamondWidthRel;
let minuteColor         = DEFAULT_minuteColor;
let showMinute          = DEFAULT_showMinute;
// VFD live values
let vfdEnabled          = DEFAULT_vfdEnabled;
let vfdColor            = DEFAULT_vfdColor;
let vfdScaleRel         = DEFAULT_vfdScaleRel;
let vfdYOffsetRel       = DEFAULT_vfdYOffsetRel;
let vfdColonPadding     = DEFAULT_vfdColonPadding;
let vfdCornerRel        = DEFAULT_vfdCornerRel;
let vfdGlowRel          = DEFAULT_vfdGlowRel;
let vfdDigitGapRel      = DEFAULT_vfdDigitGapRel;
let vfdTestMode         = 'normal'; // 'normal' | 'all' | '88'

// Apply URL overrides (if provided)
outerRel            = paramFloat('outerRel', outerRel);
minorInnerRel       = paramFloat('minorInnerRel', minorInnerRel);
majorInnerRel       = paramFloat('majorInnerRel', majorInnerRel);
minorOuterRel       = paramFloat('minorOuterRel', minorOuterRel);
minorWidthRel       = paramFloat('minorWidthRel', minorWidthRel);
majorWidthRel       = paramFloat('majorWidthRel', majorWidthRel);
numberRadiusRel     = paramFloat('numberRadiusRel', numberRadiusRel);
numberFontRel       = paramFloat('numberFontRel', numberFontRel);
centerCircleRel     = paramFloat('centerCircleRel', centerCircleRel);
shaftWidthRel       = paramFloat('shaftWidthRel', shaftWidthRel);
tipRel              = paramFloat('tipRel', tipRel);
diamondBaseInsetRel = paramFloat('diamondBaseInsetRel', diamondBaseInsetRel);
diamondBackRel      = paramFloat('diamondBackRel', diamondBackRel);
diamondWidthRel     = paramFloat('diamondWidthRel', diamondWidthRel);
bgScaleRel          = paramFloat('bgScaleRel', bgScaleRel);
logoSizeRel         = paramFloat('logoSizeRel', logoSizeRel);
showLogo            = paramBool('showLogo', showLogo);
runClock            = paramBool('runClock', runClock);
manualAngle         = paramFloat('manualAngle', manualAngle);
showBg              = paramBool('showBg', showBg);
minuteShaftWidthRel = paramFloat('minuteShaftWidthRel', minuteShaftWidthRel);
minuteTipRel        = paramFloat('minuteTipRel', minuteTipRel);
minuteDiamondBaseInsetRel = paramFloat('minuteDiamondBaseInsetRel', minuteDiamondBaseInsetRel);
minuteDiamondBackRel = paramFloat('minuteDiamondBackRel', minuteDiamondBackRel);
minuteDiamondWidthRel = paramFloat('minuteDiamondWidthRel', minuteDiamondWidthRel);
minuteColor         = params.get('minuteColor') || minuteColor;
showMinute          = paramBool('showMinute', showMinute);
// VFD params
vfdEnabled      = paramBool('vfdEnabled', vfdEnabled);
vfdColor        = params.get('vfdColor') || vfdColor;
vfdScaleRel     = paramFloat('vfdScaleRel', vfdScaleRel);
vfdYOffsetRel   = paramFloat('vfdYOffsetRel', vfdYOffsetRel);
vfdColonPadding = paramFloat('vfdColonPadding', vfdColonPadding);
vfdCornerRel    = paramFloat('vfdCornerRel', vfdCornerRel);
vfdGlowRel      = paramFloat('vfdGlowRel', vfdGlowRel);
vfdTestMode     = params.get('vfdTestMode') || vfdTestMode;
vfdDigitGapRel  = paramFloat('vfdDigitGapRel', vfdDigitGapRel);

// Reference background image for local use (ignored if not found)
const bgImage = new Image();
bgImage.src = 'bsk_klokke.png';
let bgReady = false;

// Center logo image (bsk.png) that rotates with the second hand
const centerLogoImage = new Image();
centerLogoImage.src = 'bsk.png';
let centerLogoReady = false;
let centerLogoError = false;
centerLogoImage.onload = () => { centerLogoReady = true; };
centerLogoImage.onerror = () => { centerLogoError = true; };

bgImage.onload = () => { bgReady = true; };

// Ensure custom font loads before rendering canvas text (numbers)
// In production mode, the font may not load via document.fonts.ready if left panel is hidden
let fontReady = false;
if (document.fonts && document.fonts.ready) {
  // Create a dummy element with the custom font to force the browser to load it
  const dummyEl = document.createElement('span');
  dummyEl.style.fontFamily = "'BFont', Arial, sans-serif";
  dummyEl.style.position = 'absolute';
  dummyEl.style.visibility = 'hidden';
  dummyEl.textContent = '60';
  document.body.appendChild(dummyEl);
  
  document.fonts.ready.then(() => {
    fontReady = true;
    document.body.removeChild(dummyEl);
  });
} else {
  // Fallback: assume font is ready after a delay
  setTimeout(() => { fontReady = true; }, 1000);
}

// VFD caching: only redraw when time or settings change
let lastVFDHourMinute = '';
let lastVFDSettings = '';
// Offscreen canvas used to cache the rendered VFD image so we can blit it cheaply each frame
let vfdCanvas = null;
let vfdCtx = null;
let vfdCanvasSize = 0;

function getVFDSettingsHash() {
  return `${vfdEnabled}|${vfdColor}|${vfdScaleRel}|${vfdYOffsetRel}|${vfdColonPadding}|${vfdCornerRel}|${vfdGlowRel}|${vfdDigitGapRel}|${vfdTestMode}`;
}

function resizeCanvas() {
  const vh = window.innerHeight || 800;
  const clockDiameter = vh * outerRel;
  const size = clockDiameter;
  canvas.width = size;
  canvas.height = size;
  const r = size / 2;

  // Reset transform and move origin to centre
  ctx.setTransform(1,0,0,1,0,0);
  ctx.translate(r, r);

  // Keep our offscreen VFD canvas in sync with the main canvas size
  if (!vfdCanvas || vfdCanvasSize !== size) {
    vfdCanvas = document.createElement('canvas');
    vfdCanvas.width = size;
    vfdCanvas.height = size;
    vfdCanvasSize = size;
    vfdCtx = vfdCanvas.getContext('2d');
    // Match transforms: origin at center so drawVFDDisplay can draw with same coordinates
    vfdCtx.setTransform(1,0,0,1,0,0);
    vfdCtx.translate(r, r);
    // Force VFD to re-render after a resize
    lastVFDHourMinute = '';
    lastVFDSettings = '';
  }

  return { size, r };
}

function drawBackground(size, r) {
  if (!bgReady || !showBg) return;

  const iw = bgImage.width;
  const ih = bgImage.height;
  const cw = size;
  
  const ch = size;

  const imgAspect = iw / ih;
  const canvasAspect = cw / ch;

  let dw, dh, dx, dy;
  if (imgAspect > canvasAspect) {
    // Fit height, crop left/right
    dh = ch;
    dw = dh * imgAspect;
  } else {
    // Fit width, crop top/bottom
    dw = cw;
    dh = dw / imgAspect;
  }

  // Apply extra uniform scale to fine tune reference size
  dw *= bgScaleRel;
  dh *= bgScaleRel;

  // Center the image after scaling
  dx = (cw - dw) / 2;
  dy = (ch - dh) / 2;

  ctx.save();
  ctx.globalAlpha = 0.5// set >0 locally if you want the overlay
  ctx.drawImage(bgImage, -r + dx, -r + dy, dw, dh);
  ctx.restore();
}

// Draw a VFD-style dot-matrix digital clock on the lower half of the face.
// This is a preview: it renders HH:MM (24-hour) using a 5x7 dot font and a soft neon glow.
function drawVFDDisplay(size, r, targetCtx) {
  if (!vfdEnabled) return;
  const localCtx = targetCtx || ctx;
  
  // Determine display text based on test mode
  let text;
  let testAll = false;
  if (vfdTestMode === '88') {
    text = '88:88';
  } else if (vfdTestMode === 'all') {
    text = '88:88';
    testAll = true;
  } else {
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    text = hh + ':' + mm;
  }

  // 5x7 dot patterns for digits 0-9 and colon
  const PATTERNS = {
    '0': ['01110','10001','10011','10101','11001','10001','01110'],
    '1': ['00100','01100','00100','00100','00100','00100','01110'],
    '2': ['01110','10001','00001','00010','00100','01000','11111'],
    '3': ['01110','10001','00001','00110','00001','10001','01110'],
    '4': ['00010','00110','01010','10010','11111','00010','00010'],
    '5': ['11111','10000','11110','00001','00001','10001','01110'],
    '6': ['00110','01000','10000','11110','10001','10001','01110'],
    '7': ['11111','00001','00010','00100','01000','01000','01000'],
    '8': ['01110','10001','10001','01110','10001','10001','01110'],
    '9': ['01110','10001','10001','01111','00001','00010','01100'],
    ':': ['00000','00100','00100','00000','00100','00100','00000']
  };

  // sizing
  const dotRadius = Math.max(1, r * 0.015 * vfdScaleRel);
  const dotSpacing = dotRadius * 2.4;
  const cols = 5;
  const rows = 7;
  const squareSize = dotRadius * 2;
  const cornerRadius = Math.max(1, dotRadius * vfdCornerRel);

  // gap between character groups (expressed as center-to-center distance for adjacent columns)
  // Base factor 1.3 is preserved, plus a user-controllable relative addition `vfdDigitGapRel`.
  const gapBetweenDigits = dotSpacing * (1.3 + Number(vfdDigitGapRel || 0));
  // glow multiplier used everywhere
  const glow = dotRadius * Math.max(0, vfdGlowRel);

  // Build a sequence of column counts for each character (digits => cols, colon => 1)
  const colCounts = [];
  for (let i = 0; i < text.length; i++) {
    colCounts.push(text[i] === ':' ? 1 : cols);
  }

  // Compute total columns and total width: base spacing between adjacent columns is dotSpacing.
  const totalCols = colCounts.reduce((s, c) => s + c, 0);
  // between-block extra spacing (we want gapBetweenDigits instead of plain dotSpacing at block boundaries)
  const numBlocks = colCounts.length;
  // compute per-boundary extra spacing and include colon-specific padding (vfdColonPadding is in dot units)
  const boundaryExtras = [];
  for (let i = 0; i < numBlocks - 1; i++) {
    let extra = Math.max(0, gapBetweenDigits - dotSpacing);
    // increase extra when the boundary touches a colon so the colon slider has effect
    if (text[i] === ':' || text[i+1] === ':') {
      extra += vfdColonPadding * dotSpacing;
    }
    boundaryExtras.push(extra);
  }
  const totalWidth = (totalCols - 1) * dotSpacing + boundaryExtras.reduce((s, a) => s + a, 0);

  // Starting X (leftmost column center)
  const startX = - totalWidth / 2;
  // vertical placement
  const startY = r * vfdYOffsetRel - (rows - 1) * dotSpacing / 2;

  // Build center X positions for every column of every character (so digits and colon align on same grid)
  const centers = []; // array per character: array of x centers
  let cursorX = startX;
  for (let ci = 0; ci < colCounts.length; ci++) {
    const cc = colCounts[ci];
    const thisCenters = [];
    for (let c = 0; c < cc; c++) {
      thisCenters.push(cursorX + c * dotSpacing);
    }
    centers.push(thisCenters);
    // advance cursor: cc columns take (cc-1)*dotSpacing width; move to next first-column position
    cursorX += (cc - 1) * dotSpacing + dotSpacing;
    if (ci < boundaryExtras.length) cursorX += boundaryExtras[ci];
  }

  const dotColor = vfdColor;
  localCtx.save();
  localCtx.globalCompositeOperation = 'lighter';

  function fillRoundedSquare(cx, cy, size, radius) {
    const half = size / 2;
    const x = cx - half;
    const y = cy - half;
    const rcorn = Math.min(radius, half);
    localCtx.beginPath();
    localCtx.moveTo(x + rcorn, y);
    localCtx.lineTo(x + size - rcorn, y);
    localCtx.quadraticCurveTo(x + size, y, x + size, y + rcorn);
    localCtx.lineTo(x + size, y + size - rcorn);
    localCtx.quadraticCurveTo(x + size, y + size, x + size - rcorn, y + size);
    localCtx.lineTo(x + rcorn, y + size);
    localCtx.quadraticCurveTo(x, y + size, x, y + size - rcorn);
    localCtx.lineTo(x, y + rcorn);
    localCtx.quadraticCurveTo(x, y, x + rcorn, y);
    localCtx.closePath();
    localCtx.fill();
  }

  // Draw each character by consulting centers[][] and PATTERNS
  for (let chi = 0; chi < text.length; chi++) {
    const ch = text[chi];
    const pattern = PATTERNS[ch] || PATTERNS['0'];
    const thisCenters = centers[chi];
    
    // For digits, pattern columns map 0..4 -> thisCenters[0..4]
    // For colon (1 column) we check pattern[row][2] and draw at thisCenters[0]
    for (let rrow = 0; rrow < rows; rrow++) {
      const row = pattern[rrow];
      if (!row) continue;
      
      if (testAll) {
        // Test mode: draw all possible dots
        if (ch === ':') {
          const x = thisCenters[0];
          const y = startY + rrow * dotSpacing;
          localCtx.fillStyle = dotColor;
          localCtx.shadowBlur = glow;
          localCtx.shadowColor = dotColor;
          fillRoundedSquare(x, y, squareSize, cornerRadius);
        } else {
          for (let ccol = 0; ccol < thisCenters.length; ccol++) {
            const x = thisCenters[ccol];
            const y = startY + rrow * dotSpacing;
            localCtx.fillStyle = dotColor;
            localCtx.shadowBlur = glow;
            localCtx.shadowColor = dotColor;
            fillRoundedSquare(x, y, squareSize, cornerRadius);
          }
        }
      } else {
        // Normal mode: use pattern table
        if (ch === ':') {
          if (row[2] === '1') {
            const x = thisCenters[0];
            const y = startY + rrow * dotSpacing;
            localCtx.fillStyle = dotColor;
            localCtx.shadowBlur = glow;
            localCtx.shadowColor = dotColor;
            fillRoundedSquare(x, y, squareSize, cornerRadius);
          }
        } else {
          for (let ccol = 0; ccol < thisCenters.length; ccol++) {
            if (row[ccol] === '1') {
              const x = thisCenters[ccol];
              const y = startY + rrow * dotSpacing;
              localCtx.fillStyle = dotColor;
              localCtx.shadowBlur = glow;
              localCtx.shadowColor = dotColor;
              fillRoundedSquare(x, y, squareSize, cornerRadius);
            }
          }
        }
      }
    }
  }

  localCtx.shadowBlur = 0;
  localCtx.restore();
}

function drawFace(size, r) {
  const clockRadius = r;                  // full clock radius
  const outerTickRadius = clockRadius;    // outer end of all *major* ticks
  const minorOuterRadius = clockRadius * minorOuterRel; // outer end of small ticks

  // Derived radii
  const minorInnerRadius = clockRadius * minorInnerRel;
  const majorInnerRadius = clockRadius * majorInnerRel;

  // Tick lengths
  const minorLen = minorOuterRadius - minorInnerRadius;
  const majorLen = outerTickRadius - majorInnerRadius;

  // Second marks
  for (let s = 0; s < 60; s++) {
    const angle = (Math.PI * 2) * (s / 60) - Math.PI / 2;

    const outer = (s % 5 === 0) ? outerTickRadius : minorOuterRadius;
    const inner = (s % 5 === 0) ? majorInnerRadius : minorInnerRadius;
    const widthRel = (s % 5 === 0) ? majorWidthRel : minorWidthRel;

    ctx.strokeStyle = 'white';
    ctx.lineWidth = clockRadius * widthRel; // width relative to clock size

    const xOuter = Math.cos(angle) * outer;
    const yOuter = Math.sin(angle) * outer;
    const xInner = Math.cos(angle) * inner;
    const yInner = Math.sin(angle) * inner;

    ctx.beginPath();
    ctx.moveTo(xInner, yInner);
    ctx.lineTo(xOuter, yOuter);
    ctx.stroke();
  }

  // VFD digital preview on backface (lower half)
  // Only render the VFD into the offscreen canvas when the minute or VFD settings change,
  // but blit the cached offscreen canvas every frame so it remains visible.
  const nowForVFD = new Date();
  const currentHourMinute = `${String(nowForVFD.getHours()).padStart(2, '0')}:${String(nowForVFD.getMinutes()).padStart(2, '0')}`;
  const currentVFDSettings = getVFDSettingsHash();

  // Ensure offscreen canvas exists and has correct transform (resizeCanvas should have created it)
  if (!vfdCanvas) {
    // fallback: create minimal offscreen canvas
    vfdCanvas = document.createElement('canvas');
    vfdCanvas.width = size; vfdCanvas.height = size; vfdCanvasSize = size;
    vfdCtx = vfdCanvas.getContext('2d');
    vfdCtx.setTransform(1,0,0,1,0,0); vfdCtx.translate(r, r);
    lastVFDHourMinute = '';
    lastVFDSettings = '';
  }

  if (currentHourMinute !== lastVFDHourMinute || currentVFDSettings !== lastVFDSettings) {
    // update cached VFD image
    lastVFDHourMinute = currentHourMinute;
    lastVFDSettings = currentVFDSettings;
    // clear offscreen and draw into it
    vfdCtx.setTransform(1,0,0,1,0,0);
    vfdCtx.clearRect(0, 0, vfdCanvas.width, vfdCanvas.height);
    vfdCtx.translate(r, r);
    drawVFDDisplay(size, r, vfdCtx);
  }

  // Blit cached VFD to main canvas (fast)
  if (vfdCanvas) {
    ctx.drawImage(vfdCanvas, -r, -r);
  }

  // Numbers: 5, 10, ... 55, and 60 at the top
  // Skip rendering numbers until custom font is loaded to avoid flicker
  if (!fontReady) return;

  const numberRadius = clockRadius * numberRadiusRel;

  ctx.fillStyle = 'white';
  ctx.font = `${Math.round(clockRadius * numberFontRel)}px 'BFont', Arial, sans-serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  for (let s = 0; s < 60; s += 5) {
    const angle = (Math.PI * 2) * (s / 60) - Math.PI / 2;
    let x = Math.cos(angle) * numberRadius;
    let y = Math.sin(angle) * numberRadius;
    const label = (s === 0) ? '60' : String(s);
    // Apply offset if present
    const offset = numberOffsets[s === 0 ? 60 : s];
    if (offset) {
      x += offset.x * r;
      y += offset.y * r;
    }
    ctx.fillText(label, x, y);
  }
}

function drawDiamondHand(angle, color, r) {
  const clockRadius = r;

  // Unit vectors along and perpendicular to the hand
  const nx = Math.cos(angle);
  const ny = Math.sin(angle);
  const px = Math.cos(angle + Math.PI / 2);
  const py = Math.sin(angle + Math.PI / 2);

  const tipRadius = clockRadius * tipRel;
  const diamondMidRadius  = tipRadius - clockRadius * diamondBaseInsetRel;
  const diamondBackRadius = diamondMidRadius - clockRadius * diamondBackRel;
  const shaftWidth        = clockRadius * shaftWidthRel;
  const diamondWidth      = clockRadius * diamondWidthRel;

  // ===== Shaft: from centre to *centre of the diamond* =====
  const shaftEndX = nx * diamondMidRadius;
  const shaftEndY = ny * diamondMidRadius;

  ctx.strokeStyle = color;
  ctx.lineWidth = shaftWidth;
  ctx.lineCap = 'butt';

  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(shaftEndX, shaftEndY);
  ctx.stroke();
  const frontX = nx * tipRadius;            // outer tip on tick circle
  const frontY = ny * tipRadius;

  const backX  = nx * diamondBackRadius;    // inner tip towards centre
  const backY  = ny * diamondBackRadius;

  const midX   = nx * diamondMidRadius;     // centre of diamond (for left/right corners)
  const midY   = ny * diamondMidRadius;

  const halfW  = diamondWidth / 2;
  const leftX  = midX + px * halfW;
  const leftY  = midY + py * halfW;
  const rightX = midX - px * halfW;
  const rightY = midY - py * halfW;

  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(frontX, frontY);   // outer tip
  ctx.lineTo(leftX, leftY);     // left corner
  ctx.lineTo(backX, backY);     // inner tip
  ctx.lineTo(rightX, rightY);   // right corner
  ctx.closePath();
  ctx.fill();
}

// A slightly slimmer version of the diamond hand for the minute indicator.
function drawMinuteHand(angle, color, r) {
  const clockRadius = r;

  // Unit vectors along and perpendicular to the hand
  const nx = Math.cos(angle);
  const ny = Math.sin(angle);
  const px = Math.cos(angle + Math.PI / 2);
  const py = Math.sin(angle + Math.PI / 2);

  // Use minute-specific parameters (no extra shrink factors) so same settings -> same absolute size
  const tipRadius = clockRadius * minuteTipRel;
  const diamondMidRadius  = tipRadius - clockRadius * minuteDiamondBaseInsetRel;
  const diamondBackRadius = diamondMidRadius - clockRadius * minuteDiamondBackRel;
  const shaftWidth        = clockRadius * minuteShaftWidthRel;
  const diamondWidth      = clockRadius * minuteDiamondWidthRel;

  // Shaft
  const shaftEndX = nx * diamondMidRadius;
  const shaftEndY = ny * diamondMidRadius;

  ctx.strokeStyle = color;
  ctx.lineWidth = shaftWidth;
  ctx.lineCap = 'butt';

  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(shaftEndX, shaftEndY);
  ctx.stroke();

  // Diamond head
  const frontX = nx * tipRadius;
  const frontY = ny * tipRadius;
  const backX  = nx * diamondBackRadius;
  const backY  = ny * diamondBackRadius;
  const midX   = nx * diamondMidRadius;
  const midY   = ny * diamondMidRadius;
  const halfW  = diamondWidth / 2;
  const leftX  = midX + px * halfW;
  const leftY  = midY + py * halfW;
  const rightX = midX - px * halfW;
  const rightY = midY - py * halfW;

  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(frontX, frontY);
  ctx.lineTo(leftX, leftY);
  ctx.lineTo(backX, backY);
  ctx.lineTo(rightX, rightY);
  ctx.closePath();
  ctx.fill();
}

// Draw either the rotating logo (if available) or the static center circle
function drawCenterElement(r, baseAngle) {
  const clockRadius = r;
  const centerRadius = clockRadius * centerCircleRel; // circle behind
  const logoRadius   = clockRadius * logoSizeRel;     // logo size vs full clock radius

  if (showLogo && centerLogoReady && !centerLogoError) {
    ctx.save();
    // Rotate the logo so it is right-side-up when the blue hand (baseAngle) is at the top.
    ctx.rotate(baseAngle + Math.PI / 2);
    const size = logoRadius * 2;
    ctx.drawImage(centerLogoImage, -logoRadius, -logoRadius, size, size);
    ctx.restore();
  } else {
    ctx.fillStyle = '#E1CD92';
    ctx.beginPath();
    ctx.arc(0, 0, centerRadius, 0, Math.PI * 2);
    ctx.closePath();
    ctx.fill();
  }
}

function frame() {
  const { size, r } = resizeCanvas();
  ctx.clearRect(-r, -r, size, size);
  drawBackground(size, r);
  drawFace(size, r);

  let baseAngle;
  if (runClock) {
    const t = new Date();
    const sec = t.getSeconds() + t.getMilliseconds() / 1000;
    baseAngle = (Math.PI * 2) * (sec / 60) - Math.PI / 2;
  } else {
    baseAngle = (Math.PI * 2) * manualAngle - Math.PI / 2;
  }
  // Minute hand (draw underneath the colored hands)
  let minuteAngle;
  if (runClock) {
    const tmin = new Date();
    const mins = tmin.getMinutes() + tmin.getSeconds() / 60 + tmin.getMilliseconds() / 60000;
    minuteAngle = (Math.PI * 2) * (mins / 60) - Math.PI / 2;
  } else {
    minuteAngle = (Math.PI * 2) * manualAngle - Math.PI / 2;
  }
  if (showMinute) {
    drawMinuteHand(minuteAngle, minuteColor, r);
  }

  drawDiamondHand(baseAngle,                   'blue',  r);    // up
  drawDiamondHand(baseAngle + Math.PI / 2,     'yellow',r);    // right
  drawDiamondHand(baseAngle + Math.PI,         'red',   r);    // down
  drawDiamondHand(baseAngle + 3 * Math.PI / 2, 'green', r);    // left

  // Center element on top of all hands (logo or circle)
  drawCenterElement(r, baseAngle);

  requestAnimationFrame(frame);
}

frame();

// ===== Slider wiring (all relative parameters) =====

const outerRelSlider          = document.getElementById('outerRelSlider');
const outerRelValue           = document.getElementById('outerRelValue');
const minorInnerSlider        = document.getElementById('minorInnerSlider');
const minorInnerValue         = document.getElementById('minorInnerValue');
const majorInnerSlider        = document.getElementById('majorInnerSlider');
const majorInnerValue         = document.getElementById('majorInnerValue');
const minorOuterRelSlider     = document.getElementById('minorOuterRelSlider');
const minorOuterRelValue      = document.getElementById('minorOuterRelValue');
const minorWidthRelSlider     = document.getElementById('minorWidthRelSlider');
const minorWidthRelValue      = document.getElementById('minorWidthRelValue');
const majorWidthRelSlider     = document.getElementById('majorWidthRelSlider');
const majorWidthRelValue      = document.getElementById('majorWidthRelValue');

const shaftWidthRelSlider     = document.getElementById('shaftWidthRelSlider');
const shaftWidthRelValue      = document.getElementById('shaftWidthRelValue');
const tipRelSlider            = document.getElementById('tipRelSlider');
const tipRelValue             = document.getElementById('tipRelValue');
const diamondBaseInsetRelSlider = document.getElementById('diamondBaseInsetRelSlider');
const diamondBaseInsetRelValue  = document.getElementById('diamondBaseInsetRelValue');
const diamondBackRelSlider    = document.getElementById('diamondBackRelSlider');
const diamondBackRelValue     = document.getElementById('diamondBackRelValue');
const diamondWidthRelSlider   = document.getElementById('diamondWidthRelSlider');
const diamondWidthRelValue    = document.getElementById('diamondWidthRelValue');
const centerCircleRelSlider   = document.getElementById('centerCircleRelSlider');
const centerCircleRelValue    = document.getElementById('centerCircleRelValue');

const numberRadiusRelSlider   = document.getElementById('numberRadiusRelSlider');
const numberRadiusRelValue    = document.getElementById('numberRadiusRelValue');
const numberFontRelSlider     = document.getElementById('numberFontRelSlider');
const numberFontRelValue      = document.getElementById('numberFontRelValue');
const minuteShaftWidthRelSlider = document.getElementById('minuteShaftWidthRelSlider');
const minuteShaftWidthRelValue  = document.getElementById('minuteShaftWidthRelValue');
const minuteTipRelSlider       = document.getElementById('minuteTipRelSlider');
const minuteTipRelValue        = document.getElementById('minuteTipRelValue');
const minuteDiamondBaseInsetRelSlider = document.getElementById('minuteDiamondBaseInsetRelSlider');
const minuteDiamondBaseInsetRelValue  = document.getElementById('minuteDiamondBaseInsetRelValue');
const minuteDiamondBackRelSlider = document.getElementById('minuteDiamondBackRelSlider');
const minuteDiamondBackRelValue  = document.getElementById('minuteDiamondBackRelValue');
const minuteDiamondWidthRelSlider = document.getElementById('minuteDiamondWidthRelSlider');
const minuteDiamondWidthRelValue  = document.getElementById('minuteDiamondWidthRelValue');
const minuteColorInput         = document.getElementById('minuteColorInput');
const minuteColorValue         = document.getElementById('minuteColorValue');
const showMinuteCheckbox       = document.getElementById('showMinuteCheckbox');

// VFD control elements
const showVFDCheckbox          = document.getElementById('showVFDCheckbox');
const vfdColorInput            = document.getElementById('vfdColorInput');
const vfdColorVal              = document.getElementById('vfdColorVal');
const vfdTestModeSelect        = document.getElementById('vfdTestModeSelect');
const vfdTestModeVal           = document.getElementById('vfdTestModeVal');
const vfdSizeRelSlider         = document.getElementById('vfdSizeRelSlider');
const vfdSizeRelVal            = document.getElementById('vfdSizeRelVal');
const vfdYOffsetSlider         = document.getElementById('vfdYOffsetSlider');
const vfdYOffsetVal            = document.getElementById('vfdYOffsetVal');
const vfdColonPaddingSlider    = document.getElementById('vfdColonPaddingSlider');
const vfdColonPaddingVal       = document.getElementById('vfdColonPaddingVal');
const vfdDigitGapRelSlider     = document.getElementById('vfdDigitGapRelSlider');
const vfdDigitGapRelVal        = document.getElementById('vfdDigitGapRelVal');
const vfdCornerRelSlider       = document.getElementById('vfdCornerRelSlider');
const vfdCornerRelVal          = document.getElementById('vfdCornerRelVal');
const vfdGlowRelSlider         = document.getElementById('vfdGlowRelSlider');
const vfdGlowRelVal            = document.getElementById('vfdGlowRelVal');

const bgScaleRelSlider        = document.getElementById('bgScaleRelSlider');
const bgScaleRelValue         = document.getElementById('bgScaleRelValue');

const runClockCheckbox        = document.getElementById('runClockCheckbox');
const manualAngleSlider       = document.getElementById('manualAngleSlider');
const manualAngleValue        = document.getElementById('manualAngleValue');
const showLogoCheckbox        = document.getElementById('showLogoCheckbox');
const logoSizeRelSlider       = document.getElementById('logoSizeRelSlider');
const logoSizeRelValue        = document.getElementById('logoSizeRelValue');
const showBgCheckbox          = document.getElementById('showBgCheckbox');
const copyUrlButton           = document.getElementById('copyUrlButton');
const copyUrlStatus           = document.getElementById('copyUrlStatus');

function syncControls() {
  outerRelSlider.value          = outerRel;
  outerRelValue.textContent     = outerRel.toFixed(3);

  minorInnerSlider.value        = minorInnerRel;
  minorInnerValue.textContent   = minorInnerRel.toFixed(3);

  majorInnerSlider.value        = majorInnerRel;
  majorInnerValue.textContent   = majorInnerRel.toFixed(3);

  minorOuterRelSlider.value     = minorOuterRel;
  minorOuterRelValue.textContent= minorOuterRel.toFixed(3);

  minorWidthRelSlider.value     = minorWidthRel;
  minorWidthRelValue.textContent= minorWidthRel.toFixed(3);

  majorWidthRelSlider.value     = majorWidthRel;
  majorWidthRelValue.textContent= majorWidthRel.toFixed(3);

  shaftWidthRelSlider.value     = shaftWidthRel;
  shaftWidthRelValue.textContent= shaftWidthRel.toFixed(3);

  tipRelSlider.value            = tipRel;
  tipRelValue.textContent       = tipRel.toFixed(3);

  diamondBaseInsetRelSlider.value  = diamondBaseInsetRel;
  diamondBaseInsetRelValue.textContent = diamondBaseInsetRel.toFixed(3);

  diamondBackRelSlider.value    = diamondBackRel;
  diamondBackRelValue.textContent = diamondBackRel.toFixed(3);

  diamondWidthRelSlider.value   = diamondWidthRel;
  diamondWidthRelValue.textContent = diamondWidthRel.toFixed(3);

  centerCircleRelSlider.value   = centerCircleRel;
  centerCircleRelValue.textContent = centerCircleRel.toFixed(3);

  numberRadiusRelSlider.value   = numberRadiusRel;
  numberRadiusRelValue.textContent = numberRadiusRel.toFixed(3);

  numberFontRelSlider.value     = numberFontRel;
  numberFontRelValue.textContent = numberFontRel.toFixed(3);

  bgScaleRelSlider.value        = bgScaleRel;
  bgScaleRelValue.textContent   = bgScaleRel.toFixed(3);

  // Minute hand controls
  showMinuteCheckbox.checked    = showMinute;
  minuteShaftWidthRelSlider.value = minuteShaftWidthRel;
  minuteShaftWidthRelValue.textContent = minuteShaftWidthRel.toFixed(3);
  minuteTipRelSlider.value      = minuteTipRel;
  minuteTipRelValue.textContent = minuteTipRel.toFixed(3);
  minuteDiamondBaseInsetRelSlider.value = minuteDiamondBaseInsetRel;
  minuteDiamondBaseInsetRelValue.textContent = minuteDiamondBaseInsetRel.toFixed(3);
  minuteDiamondBackRelSlider.value = minuteDiamondBackRel;
  minuteDiamondBackRelValue.textContent = minuteDiamondBackRel.toFixed(3);
  minuteDiamondWidthRelSlider.value = minuteDiamondWidthRel;
  minuteDiamondWidthRelValue.textContent = minuteDiamondWidthRel.toFixed(3);
  minuteColorInput.value        = minuteColor;
  minuteColorValue.textContent  = minuteColor;

  // VFD controls
  showVFDCheckbox.checked      = vfdEnabled;
  vfdColorInput.value          = vfdColor;
  vfdColorVal.textContent      = vfdColor;
  vfdTestModeSelect.value      = vfdTestMode;
  vfdTestModeVal.textContent   = vfdTestMode;
  vfdSizeRelSlider.value       = vfdScaleRel;
  vfdSizeRelVal.textContent    = vfdScaleRel.toFixed(2);
  vfdYOffsetSlider.value       = vfdYOffsetRel;
  vfdYOffsetVal.textContent    = vfdYOffsetRel.toFixed(2);
  vfdColonPaddingSlider.value  = vfdColonPadding;
  vfdColonPaddingVal.textContent = vfdColonPadding.toFixed(2);
  vfdDigitGapRelSlider.value   = vfdDigitGapRel;
  vfdDigitGapRelVal.textContent= vfdDigitGapRel.toFixed(2);
  vfdCornerRelSlider.value     = vfdCornerRel;
  vfdCornerRelVal.textContent  = vfdCornerRel.toFixed(2);
  vfdGlowRelSlider.value       = vfdGlowRel;
  vfdGlowRelVal.textContent    = vfdGlowRel.toFixed(2);

  runClockCheckbox.checked      = runClock;
  showLogoCheckbox.checked      = showLogo;
  logoSizeRelSlider.value       = logoSizeRel;
  logoSizeRelValue.textContent  = logoSizeRel.toFixed(3);
  manualAngleSlider.value       = manualAngle;
  manualAngleSlider.disabled    = runClock;
  manualAngleValue.textContent  = manualAngle.toFixed(3);
  showBgCheckbox.checked        = showBg;
}

outerRelSlider.addEventListener('input', () => {
  outerRel = parseFloat(outerRelSlider.value);
  outerRelValue.textContent = outerRel.toFixed(3);
});

minorInnerSlider.addEventListener('input', () => {
  minorInnerRel = parseFloat(minorInnerSlider.value);
  minorInnerValue.textContent = minorInnerRel.toFixed(3);
});

majorInnerSlider.addEventListener('input', () => {
  majorInnerRel = parseFloat(majorInnerSlider.value);
  majorInnerValue.textContent = majorInnerRel.toFixed(3);
});

minorOuterRelSlider.addEventListener('input', () => {
  minorOuterRel = parseFloat(minorOuterRelSlider.value);
  minorOuterRelValue.textContent = minorOuterRel.toFixed(3);
});

minorWidthRelSlider.addEventListener('input', () => {
  minorWidthRel = parseFloat(minorWidthRelSlider.value);
  minorWidthRelValue.textContent = minorWidthRel.toFixed(3);
});

majorWidthRelSlider.addEventListener('input', () => {
  majorWidthRel = parseFloat(majorWidthRelSlider.value);
  majorWidthRelValue.textContent = majorWidthRel.toFixed(3);
});

shaftWidthRelSlider.addEventListener('input', () => {
  shaftWidthRel = parseFloat(shaftWidthRelSlider.value);
  shaftWidthRelValue.textContent = shaftWidthRel.toFixed(3);
});

tipRelSlider.addEventListener('input', () => {
  tipRel = parseFloat(tipRelSlider.value);
  tipRelValue.textContent = tipRel.toFixed(3);
});

diamondBaseInsetRelSlider.addEventListener('input', () => {
  diamondBaseInsetRel = parseFloat(diamondBaseInsetRelSlider.value);
  diamondBaseInsetRelValue.textContent = diamondBaseInsetRel.toFixed(3);
});

diamondBackRelSlider.addEventListener('input', () => {
  diamondBackRel = parseFloat(diamondBackRelSlider.value);
  diamondBackRelValue.textContent = diamondBackRel.toFixed(3);
});

diamondWidthRelSlider.addEventListener('input', () => {
  diamondWidthRel = parseFloat(diamondWidthRelSlider.value);
  diamondWidthRelValue.textContent = diamondWidthRel.toFixed(3);
});

centerCircleRelSlider.addEventListener('input', () => {
  centerCircleRel = parseFloat(centerCircleRelSlider.value);
  centerCircleRelValue.textContent = centerCircleRel.toFixed(3);
});

numberRadiusRelSlider.addEventListener('input', () => {
  numberRadiusRel = parseFloat(numberRadiusRelSlider.value);
  numberRadiusRelValue.textContent = numberRadiusRel.toFixed(3);
});

minuteShaftWidthRelSlider.addEventListener('input', () => {
  minuteShaftWidthRel = parseFloat(minuteShaftWidthRelSlider.value);
  minuteShaftWidthRelValue.textContent = minuteShaftWidthRel.toFixed(3);
});

// VFD control handlers
vfdColorInput.addEventListener('input', () => {
  vfdColor = vfdColorInput.value;
  vfdColorVal.textContent = vfdColor;
});

vfdTestModeSelect.addEventListener('change', () => {
  vfdTestMode = vfdTestModeSelect.value;
  vfdTestModeVal.textContent = vfdTestMode;
});

vfdSizeRelSlider.addEventListener('input', () => {
  vfdScaleRel = parseFloat(vfdSizeRelSlider.value);
  vfdSizeRelVal.textContent = vfdScaleRel.toFixed(2);
});

vfdYOffsetSlider.addEventListener('input', () => {
  vfdYOffsetRel = parseFloat(vfdYOffsetSlider.value);
  vfdYOffsetVal.textContent = vfdYOffsetRel.toFixed(2);
});

vfdColonPaddingSlider.addEventListener('input', () => {
  vfdColonPadding = parseFloat(vfdColonPaddingSlider.value);
  vfdColonPaddingVal.textContent = vfdColonPadding.toFixed(2);
});

vfdDigitGapRelSlider.addEventListener('input', () => {
  vfdDigitGapRel = parseFloat(vfdDigitGapRelSlider.value);
  vfdDigitGapRelVal.textContent = vfdDigitGapRel.toFixed(2);
});

vfdCornerRelSlider.addEventListener('input', () => {
  vfdCornerRel = parseFloat(vfdCornerRelSlider.value);
  vfdCornerRelVal.textContent = vfdCornerRel.toFixed(2);
});

vfdGlowRelSlider.addEventListener('input', () => {
  vfdGlowRel = parseFloat(vfdGlowRelSlider.value);
  vfdGlowRelVal.textContent = vfdGlowRel.toFixed(2);
});

showVFDCheckbox.addEventListener('change', () => {
  vfdEnabled = showVFDCheckbox.checked;
});

minuteTipRelSlider.addEventListener('input', () => {
  minuteTipRel = parseFloat(minuteTipRelSlider.value);
  minuteTipRelValue.textContent = minuteTipRel.toFixed(3);
});

minuteDiamondBaseInsetRelSlider.addEventListener('input', () => {
  minuteDiamondBaseInsetRel = parseFloat(minuteDiamondBaseInsetRelSlider.value);
  minuteDiamondBaseInsetRelValue.textContent = minuteDiamondBaseInsetRel.toFixed(3);
});

minuteDiamondBackRelSlider.addEventListener('input', () => {
  minuteDiamondBackRel = parseFloat(minuteDiamondBackRelSlider.value);
  minuteDiamondBackRelValue.textContent = minuteDiamondBackRel.toFixed(3);
});

minuteDiamondWidthRelSlider.addEventListener('input', () => {
  minuteDiamondWidthRel = parseFloat(minuteDiamondWidthRelSlider.value);
  minuteDiamondWidthRelValue.textContent = minuteDiamondWidthRel.toFixed(3);
});

minuteColorInput.addEventListener('input', () => {
  minuteColor = minuteColorInput.value;
  minuteColorValue.textContent = minuteColor;
});

showMinuteCheckbox.addEventListener('change', () => {
  showMinute = showMinuteCheckbox.checked;
});

numberFontRelSlider.addEventListener('input', () => {
  numberFontRel = parseFloat(numberFontRelSlider.value);
  numberFontRelValue.textContent = numberFontRel.toFixed(3);
});

bgScaleRelSlider.addEventListener('input', () => {
  bgScaleRel = parseFloat(bgScaleRelSlider.value);
  bgScaleRelValue.textContent = bgScaleRel.toFixed(3);
});

runClockCheckbox.addEventListener('change', () => {
  runClock = runClockCheckbox.checked;
  manualAngleSlider.disabled = runClock;
});

showLogoCheckbox.addEventListener('change', () => {
  showLogo = showLogoCheckbox.checked;
});

logoSizeRelSlider.addEventListener('input', () => {
  logoSizeRel = parseFloat(logoSizeRelSlider.value);
  logoSizeRelValue.textContent = logoSizeRel.toFixed(3);
});

manualAngleSlider.addEventListener('input', () => {
  manualAngle = parseFloat(manualAngleSlider.value);
  manualAngleValue.textContent = manualAngle.toFixed(3);
});

showBgCheckbox.addEventListener('change', () => {
  showBg = showBgCheckbox.checked;
});

function buildConfigUrl() {
  const base = window.location.origin + window.location.pathname;
  const qs = new URLSearchParams();

  // Do NOT include setupmode in generated production URLs
// (setupmode is only for design-time editing)
// Therefore: do NOT set it here.

  const addFloat = (name, current, def, precision = 3) => {
    if (Math.abs(current - def) > 1e-6) {
      qs.set(name, current.toFixed(precision));
    }
  };

  const addBool = (name, current, def) => {
    if (current !== def) {
      qs.set(name, current ? '1' : '0');
    }
  };

  addFloat('outerRel',            outerRel,            DEFAULT_outerRel);
  addFloat('minorInnerRel',       minorInnerRel,       DEFAULT_minorInnerRel);
  addFloat('majorInnerRel',       majorInnerRel,       DEFAULT_majorInnerRel);
  addFloat('minorOuterRel',       minorOuterRel,       DEFAULT_minorOuterRel);
  addFloat('minorWidthRel',       minorWidthRel,       DEFAULT_minorWidthRel);
  addFloat('majorWidthRel',       majorWidthRel,       DEFAULT_majorWidthRel);
  addFloat('numberRadiusRel',     numberRadiusRel,     DEFAULT_numberRadiusRel);
  addFloat('numberFontRel',       numberFontRel,       DEFAULT_numberFontRel);
  addFloat('centerCircleRel',     centerCircleRel,     DEFAULT_centerCircleRel);
  addFloat('shaftWidthRel',       shaftWidthRel,       DEFAULT_shaftWidthRel);
  addFloat('tipRel',              tipRel,              DEFAULT_tipRel);
  addFloat('diamondBaseInsetRel', diamondBaseInsetRel, DEFAULT_diamondBaseInsetRel);
  addFloat('diamondBackRel',      diamondBackRel,      DEFAULT_diamondBackRel);
  addFloat('diamondWidthRel',     diamondWidthRel,     DEFAULT_diamondWidthRel);
  addFloat('bgScaleRel',          bgScaleRel,          DEFAULT_bgScaleRel);
  addFloat('logoSizeRel',         logoSizeRel,         DEFAULT_logoSizeRel);
  addFloat('manualAngle',         manualAngle,         DEFAULT_manualAngle, 4);

  // Minute hand settings
  addFloat('minuteShaftWidthRel', minuteShaftWidthRel, DEFAULT_minuteShaftWidthRel);
  addFloat('minuteTipRel',        minuteTipRel,        DEFAULT_minuteTipRel);
  addFloat('minuteDiamondBaseInsetRel', minuteDiamondBaseInsetRel, DEFAULT_minuteDiamondBaseInsetRel);
  addFloat('minuteDiamondBackRel', minuteDiamondBackRel, DEFAULT_minuteDiamondBackRel);
  addFloat('minuteDiamondWidthRel', minuteDiamondWidthRel, DEFAULT_minuteDiamondWidthRel);
  if (minuteColor !== DEFAULT_minuteColor) qs.set('minuteColor', minuteColor);

  // VFD settings
  addBool('vfdEnabled', vfdEnabled, DEFAULT_vfdEnabled);
  if (vfdColor !== DEFAULT_vfdColor) qs.set('vfdColor', vfdColor);
  addFloat('vfdScaleRel', vfdScaleRel, DEFAULT_vfdScaleRel);
  addFloat('vfdYOffsetRel', vfdYOffsetRel, DEFAULT_vfdYOffsetRel);
  addFloat('vfdColonPadding', vfdColonPadding, DEFAULT_vfdColonPadding);
  addFloat('vfdDigitGapRel', vfdDigitGapRel, DEFAULT_vfdDigitGapRel);
  addFloat('vfdCornerRel', vfdCornerRel, DEFAULT_vfdCornerRel);
  addFloat('vfdGlowRel', vfdGlowRel, DEFAULT_vfdGlowRel);
  if (vfdTestMode !== 'normal') qs.set('vfdTestMode', vfdTestMode);

  addBool('showLogo', showLogo, DEFAULT_showLogo);
  addBool('runClock', runClock, DEFAULT_runClock);
  addBool('showBg', showBg, DEFAULT_showBg);
  addBool('showMinute', showMinute, DEFAULT_showMinute);

  const query = qs.toString();
  return query ? `${base}?${query}` : base;
}

copyUrlButton.addEventListener('click', () => {
  const link = buildConfigUrl();
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(link)
      .then(() => {
        copyUrlStatus.textContent = 'Copied URL';
        setTimeout(() => { copyUrlStatus.textContent = ''; }, 2000);
      })
      .catch(() => {
        copyUrlStatus.textContent = 'Copy failed';
        setTimeout(() => { copyUrlStatus.textContent = ''; }, 2000);
      });
  } else {
    // Fallback: simple prompt
    window.prompt('Copy this URL:', link);
  }
});

syncControls();

// Re-run layout on resize to honour outerRel
window.addEventListener('resize', () => {
  // Next frame() call will pick up the new size
});
</script>
</body>
</html>
